<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:LabInvoiceSystem.ViewModels"
             mc:Ignorable="d" d:DesignWidth="1000" d:DesignHeight="700"
             x:Class="LabInvoiceSystem.Views.StatisticsView"
             x:DataType="vm:StatisticsViewModel">

    <Grid RowDefinitions="Auto,Auto,*">
        <!-- Top Bar -->
        <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Margin="0,0,0,24">
            <StackPanel Spacing="4">
                <TextBlock Text="仪表盘" FontSize="24" FontWeight="Bold"/>
                <TextBlock Text="API设置与数据概览" FontSize="14" Foreground="{DynamicResource TextSecondaryBrush}"/>
            </StackPanel>
            
            <Button Grid.Column="1" 
                    Command="{Binding RefreshCommand}"
                    Classes="Primary">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <PathIcon Data="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                    <TextBlock Text="刷新数据"/>
                </StackPanel>
            </Button>
        </Grid>

        <Border Grid.Row="1" Classes="Card" Margin="0,0,0,24">
            <Grid ColumnDefinitions="*,Auto">
                <StackPanel Spacing="8">
                    <TextBlock Text="Baidu OCR API" FontSize="14" Foreground="{DynamicResource TextSecondaryBrush}"/>
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Border Width="10" Height="10" CornerRadius="5"
                                Background="{DynamicResource SuccessBrush}"/>
                        <TextBlock Text="{Binding ApiStatusText}" FontSize="16" FontWeight="SemiBold"/>
                    </StackPanel>
                    <TextBlock Text="{Binding MonthlyApiUsageText}" FontSize="12" Foreground="{DynamicResource TextSecondaryBrush}"/>
                </StackPanel>

                <Button Grid.Column="1"
                        Command="{Binding OpenApiSettingsCommand}"
                        Theme="{DynamicResource TransparentButton}">
                    <Border CornerRadius="12"
                            Padding="12,8"
                            Background="{DynamicResource NavHoverBackgroundBrush}">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <PathIcon Data="M3 3H21V21H3Z"
                                      Width="18"
                                      Height="18"
                                      Foreground="{DynamicResource PrimaryBrush}"/>
                            <TextBlock Text="配置百度 API"
                                       FontWeight="SemiBold"
                                       Foreground="{DynamicResource PrimaryBrush}"/>
                        </StackPanel>
                    </Border>
                </Button>
            </Grid>
        </Border>

        <ScrollViewer Grid.Row="2">
            <StackPanel Spacing="24">
                <!-- KPI Cards -->
                <Grid ColumnDefinitions="*,24,*,24,*">
                    <!-- Total Amount -->
                    <Border Grid.Column="0" Classes="Card">
                        <Grid ColumnDefinitions="*,Auto">
                            <StackPanel Spacing="8">
                                <TextBlock Text="累计报销金额" FontSize="14" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                <TextBlock Text="{Binding TotalAmount, StringFormat='{}{0:C}'}" FontSize="28" FontWeight="Bold" Foreground="{DynamicResource PrimaryBrush}"/>
                            </StackPanel>
                            <Border Grid.Column="1" Width="48" Height="48" CornerRadius="12" Background="{DynamicResource Indigo400}" Opacity="0.1"></Border>
                            <PathIcon Grid.Column="1" Data="M7,15H9C9,16.08 10.37,17 12,17C13.63,17 15,16.08 15,15C15,13.9 13.96,13.5 11.76,12.97C9.64,12.44 7,11.78 7,9C7,7.21 8.47,5.69 10.5,5.18V3H13.5V5.18C15.53,5.69 17,7.21 17,9H15C15,7.92 13.63,7 12,7C10.37,7 9,7.92 9,9C9,10.1 10.04,10.5 12.24,11.03C14.36,11.56 17,12.22 17,15C17,16.79 15.53,18.31 13.5,18.82V21H10.5V18.82C8.47,18.31 7,16.79 7,15Z" 
                                      Width="24" Height="24" Foreground="{DynamicResource Indigo600}"/>
                        </Grid>
                    </Border>

                    <!-- Invoice Count -->
                    <Border Grid.Column="2" Classes="Card">
                        <Grid ColumnDefinitions="*,Auto">
                            <StackPanel Spacing="8">
                                <TextBlock Text="累计发票数量" FontSize="14" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                <TextBlock Text="{Binding TotalCount}" FontSize="28" FontWeight="Bold" Foreground="{DynamicResource Emerald500}"/>
                            </StackPanel>
                            <Border Grid.Column="1" Width="48" Height="48" CornerRadius="12" Background="{DynamicResource Emerald400}" Opacity="0.1"/>
                            <PathIcon Grid.Column="1" Data="M14,17H7V15H14M17,13H7V11H17M17,9H7V7H17M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3Z" 
                                      Width="24" Height="24" Foreground="{DynamicResource Emerald500}"/>
                        </Grid>
                    </Border>

                    <!-- Last 30 Days Amount -->
                    <Border Grid.Column="4" Classes="Card">
                        <Grid ColumnDefinitions="*,Auto">
                            <StackPanel Spacing="8">
                                <TextBlock Text="近30天报账金额" FontSize="14" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                <TextBlock Text="{Binding Last30DaysAmount, StringFormat='{}{0:C}'}" FontSize="28" FontWeight="Bold" Foreground="{DynamicResource Red500}"/>
                            </StackPanel>
                            <Border Grid.Column="1" Width="48" Height="48" CornerRadius="12" Background="{DynamicResource Red400}" Opacity="0.1"/>
                            <PathIcon Grid.Column="1" Data="M9,10V12H7V10H9M13,10V12H11V10H13M17,10V12H15V10H17M19,3A2,2 0 0,1 21,5V19A2,2 0 0,1 19,21H5C3.89,21 3,20.1 3,19V5A2,2 0 0,1 5,3H6V1H8V3H16V1H18V3H19M19,19V8H5V19H19M9,14V16H7V14H9M13,14V16H11V14H13M17,14V16H15V14H17Z" 
                                      Width="24" Height="24" Foreground="{DynamicResource Red500}"/>
                        </Grid>
                    </Border>
                </Grid>

                <!-- Heatmap -->
                <Border Classes="Card">
                    <StackPanel Spacing="16">
                        <Grid ColumnDefinitions="*,Auto">
                            <TextBlock Text="报账热力图" FontSize="18" FontWeight="SemiBold"/>
                            <TextBlock Grid.Column="1" Text="过去一年的报账活动" FontSize="12" Foreground="{DynamicResource TextSecondaryBrush}" VerticalAlignment="Center"/>
                        </Grid>
                        
                        <!-- Heatmap Grid -->
                        <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled">
                            <ItemsControl ItemsSource="{Binding HeatmapData}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <UniformGrid Rows="7" Columns="53"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Width="14" Height="14" 
                                                Margin="2"
                                                CornerRadius="2"
                                                Background="{Binding ColorHex}">
                                            <ToolTip.Tip>
                                                <StackPanel>
                                                    <TextBlock Text="{Binding Date, StringFormat='yyyy-MM-dd'}" FontWeight="SemiBold"/>
                                                    <TextBlock Text="{Binding Amount, StringFormat='金额: ¥{0:N2}'}"/>
                                                </StackPanel>
                                            </ToolTip.Tip>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                        
                        <!-- Legend -->
                        <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right">
                            <TextBlock Text="少" FontSize="12" Foreground="{DynamicResource TextSecondaryBrush}" VerticalAlignment="Center"/>
                            <Border Width="14" Height="14" CornerRadius="2" Background="#F1F5F9"/>
                            <Border Width="14" Height="14" CornerRadius="2" Background="#C7D2FE"/>
                            <Border Width="14" Height="14" CornerRadius="2" Background="#818CF8"/>
                            <Border Width="14" Height="14" CornerRadius="2" Background="#4F46E5"/>
                            <Border Width="14" Height="14" CornerRadius="2" Background="#3730A3"/>
                            <TextBlock Text="多" FontSize="12" Foreground="{DynamicResource TextSecondaryBrush}" VerticalAlignment="Center"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>

        <Border Grid.RowSpan="3"
                Background="#80000000"
                IsVisible="{Binding IsApiSettingsOpen}">
            <Grid HorizontalAlignment="Center"
                  VerticalAlignment="Center"
                  Width="420">
                <Border Classes="Card">
                    <StackPanel Spacing="16">
                        <TextBlock Text="配置 Baidu OCR API"
                                   FontSize="18"
                                   FontWeight="Bold"/>

                        <StackPanel Spacing="4">
                            <TextBlock Text="API Key"
                                       FontSize="12"
                                       FontWeight="SemiBold"
                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                            <TextBox Text="{Binding ApiKeyInput}"/>
                        </StackPanel>

                        <StackPanel Spacing="4">
                            <TextBlock Text="Secret Key"
                                       FontSize="12"
                                       FontWeight="SemiBold"
                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                            <TextBox Text="{Binding SecretKeyInput}"/>
                        </StackPanel>

                        <TextBlock Text="{Binding TestResultMessage}"
                                   FontSize="12"
                                   Foreground="{DynamicResource TextSecondaryBrush}"/>

                        <StackPanel Orientation="Horizontal"
                                    HorizontalAlignment="Right"
                                    Spacing="12">
                            <Button Command="{Binding TestApiCommand}">
                                <TextBlock Text="测试连接"/>
                            </Button>

                            <Button Classes="Primary"
                                    Command="{Binding SaveApiConfigCommand}">
                                <TextBlock Text="保存配置"/>
                            </Button>

                            <Button Theme="{DynamicResource TransparentButton}"
                                    Command="{Binding CloseApiSettingsCommand}">
                                <TextBlock Text="取消"/>
                            </Button>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>
    </Grid>
</UserControl>
