<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:LabInvoiceSystem.ViewModels"
             mc:Ignorable="d" d:DesignWidth="1000" d:DesignHeight="700"
             x:Class="LabInvoiceSystem.Views.InvoiceExportView"
             x:DataType="vm:InvoiceExportViewModel">

    <Grid RowDefinitions="Auto,*">
        <!-- Top Bar -->
        <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Margin="20,0,20,20">
            <StackPanel Spacing="4">
                <TextBlock Text="数据导出" FontSize="24" FontWeight="Bold"/>
                <TextBlock Text="按日期归档的发票数据" FontSize="14" Foreground="{DynamicResource TextSecondaryBrush}"/>
            </StackPanel>
            
            <Button Grid.Column="1" 
                    Command="{Binding RefreshCommand}"
                    Classes="Primary">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <PathIcon Data="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                    <TextBlock Text="刷新列表"/>
                </StackPanel>
            </Button>
        </Grid>

        <!-- Grouped List -->
        <ScrollViewer Grid.Row="1">
            <ItemsControl ItemsSource="{Binding DateGroups}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Border Classes="Card" Margin="0,0,0,24">
                            <StackPanel Spacing="16">
                                <!-- Group Header -->
                                <Grid ColumnDefinitions="*,Auto">
                                    <StackPanel Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
                                        <Border Width="40" Height="40" CornerRadius="10" Background="{DynamicResource Slate100}">
                                            <PathIcon Data="{StaticResource IconArchive}" Width="20" Height="20" Foreground="{DynamicResource Slate600}"/>
                                        </Border>
                                        <StackPanel>
                                            <TextBlock Text="{Binding Date}" FontSize="18" FontWeight="SemiBold"/>
                                            <TextBlock FontSize="12" 
                                                       Foreground="{DynamicResource TextSecondaryBrush}">
                                                <TextBlock.Text>
                                                    <MultiBinding StringFormat='共 {0} 张发票 | 总金额: ¥{1:F2}'>
                                                        <Binding Path="TotalCount" />
                                                        <Binding Path="TotalAmount" />
                                                    </MultiBinding>
                                                </TextBlock.Text>
                                            </TextBlock>
                                        </StackPanel>
                                    </StackPanel>
                                    
                                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="12" ClipToBounds="False">
                                        <Button Command="{Binding $parent[UserControl].((vm:InvoiceExportViewModel)DataContext).ExportDateCommand}"
                                                CommandParameter="{Binding Date}"
                                                Classes="Primary">
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <PathIcon Data="{StaticResource IconExport}"/>
                                                <TextBlock Text="导出为 ZIP"/>
                                            </StackPanel>
                                        </Button>
                                        
                                        <Button Command="{Binding $parent[UserControl].((vm:InvoiceExportViewModel)DataContext).DeleteDateGroupCommand}"
                                                CommandParameter="{Binding Date}"
                                                Classes="Danger">
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <PathIcon Data="{StaticResource IconDelete}"/>
                                                <TextBlock Text="删除"/>
                                            </StackPanel>
                                        </Button>
                                    </StackPanel>
                                </Grid>
                                
                                <Border Height="1" Background="{DynamicResource BorderBrush}"/>
                                
                                <!-- Invoices Table -->
                                <Grid RowDefinitions="Auto,*">
                                    <!-- Table Header -->
                                    <Border Background="{DynamicResource GridHeaderBackgroundBrush}" CornerRadius="8,8,0,0" Padding="12,10">
                                        <Grid ColumnDefinitions="3*,1.5*,1.5*,2*,1.5*,1*" ColumnSpacing="8">
                                            <TextBlock Text="文件名" FontWeight="SemiBold" TextAlignment="Center" VerticalAlignment="Center"/>
                                            <TextBlock Grid.Column="1" Text="日期" FontWeight="SemiBold" TextAlignment="Center" VerticalAlignment="Center"/>
                                            <TextBlock Grid.Column="2" Text="金额" FontWeight="SemiBold" TextAlignment="Center" VerticalAlignment="Center"/>
                                            <TextBlock Grid.Column="3" Text="项目" FontWeight="SemiBold" TextAlignment="Center" VerticalAlignment="Center"/>
                                            <TextBlock Grid.Column="4" Text="支付方式" FontWeight="SemiBold" TextAlignment="Center" VerticalAlignment="Center"/>
                                            <TextBlock Grid.Column="5" Text="操作" FontWeight="SemiBold" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        </Grid>
                                    </Border>

                                    <!-- Table Body -->
                                    <Border Grid.Row="1"
                                            BorderBrush="{DynamicResource BorderBrush}"
                                            BorderThickness="1"
                                            CornerRadius="0,0,8,8"
                                            MaxHeight="400">
                                        <ScrollViewer HorizontalScrollBarVisibility="Disabled"
                                                      VerticalScrollBarVisibility="Auto">
                                            <ItemsControl ItemsSource="{Binding Invoices}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border BorderBrush="{DynamicResource BorderBrush}"
                                                                BorderThickness="0,0,0,1"
                                                                Padding="12"
                                                                ClipToBounds="False">
                                                            <Grid ColumnDefinitions="3*,1.5*,1.5*,2*,1.5*,1*"
                                                                  VerticalAlignment="Center"
                                                                  ColumnSpacing="8"
                                                                  ClipToBounds="False">
                                                                <TextBlock Text="{Binding FileName}" TextTrimming="CharacterEllipsis" TextAlignment="Center" VerticalAlignment="Center"/>
                                                                <TextBlock Grid.Column="1" Text="{Binding InvoiceInfo.InvoiceDate, StringFormat='yyyy-MM-dd'}" TextAlignment="Center" VerticalAlignment="Center"/>
                                                                <TextBlock Grid.Column="2" Text="{Binding InvoiceInfo.Amount, StringFormat='{}{0:C}'}" TextAlignment="Center" VerticalAlignment="Center"/>
                                                                <TextBlock Grid.Column="3" Text="{Binding InvoiceInfo.ItemName}" TextTrimming="CharacterEllipsis" TextAlignment="Center" VerticalAlignment="Center"/>
                                                                <TextBlock Grid.Column="4" Text="{Binding InvoiceInfo.PaymentMethod}" TextAlignment="Center" VerticalAlignment="Center"/>
                                                                <StackPanel Grid.Column="5" Orientation="Horizontal" Spacing="4" HorizontalAlignment="Center" ClipToBounds="False">
                                                                    <Button Classes="NavButton"
                                                                            Padding="10,6"
                                                                            ClipToBounds="False"
                                                                            Command="{Binding $parent[UserControl].((vm:InvoiceExportViewModel)DataContext).DownloadInvoiceCommand}"
                                                                            CommandParameter="{Binding}"
                                                                            ToolTip.Tip="下载">
                                                                        <PathIcon Data="M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z" Width="16" Height="16" Margin="0" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                                                    </Button>
                                                                    <Button Classes="NavButton"
                                                                            Padding="10,6"
                                                                            ClipToBounds="False"
                                                                            Command="{Binding $parent[UserControl].((vm:InvoiceExportViewModel)DataContext).DeleteInvoiceCommand}"
                                                                            CommandParameter="{Binding}"
                                                                            ToolTip.Tip="删除">
                                                                        <PathIcon Data="{StaticResource IconDelete}" Width="16" Height="16" Margin="0" Foreground="{DynamicResource Red500}" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                                                    </Button>
                                                                </StackPanel>
                                                            </Grid>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </ScrollViewer>
                                    </Border>
                                </Grid>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>
        
        <!-- Empty State -->
        <Grid Grid.Row="1" IsVisible="{Binding !DateGroups.Count}">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="16" Opacity="0.5">
                <PathIcon Data="{StaticResource IconArchive}" Width="64" Height="64" Foreground="{DynamicResource TextSecondaryBrush}"/>
                <TextBlock Text="暂无归档数据" FontSize="16" Foreground="{DynamicResource TextSecondaryBrush}"/>
            </StackPanel>
        </Grid>
    </Grid>
</UserControl>
